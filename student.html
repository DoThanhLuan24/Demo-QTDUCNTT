<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Sinh Vi√™n - ƒêƒÉng K√Ω L·ªõp H·ªçc</title>
        <style>
            * {
                margin: 0;
                padding: 0;
                box-sizing: border-box;
            }

            body {
                font-family: "Segoe UI", sans-serif;
                background: #f5f7fa;
                color: #333;
            }

            .header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 1rem 0;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            }

            .header__content {
                max-width: 1200px;
                margin: 0 auto;
                padding: 0 1rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .header__logo {
                font-size: 1.5rem;
                font-weight: bold;
            }

            .header__user {
                display: flex;
                align-items: center;
                gap: 1rem;
            }

            .user__name {
                font-weight: 600;
            }

            .user__role {
                font-size: 0.875rem;
                opacity: 0.9;
            }

            .btn-logout {
                background: rgba(255, 255, 255, 0.2);
                border: 2px solid rgba(255, 255, 255, 0.3);
                color: white;
                padding: 0.5rem 1rem;
                border-radius: 20px;
                cursor: pointer;
                transition: all 0.3s;
            }

            .btn-logout:hover {
                background: rgba(255, 255, 255, 0.3);
            }

            .container {
                max-width: 1200px;
                margin: 2rem auto;
                padding: 0 1rem;
            }

            .welcome-section {
                background: white;
                padding: 2rem;
                border-radius: 12px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
                margin-bottom: 2rem;
            }

            .welcome-section h2 {
                color: #667eea;
                margin-bottom: 1rem;
            }

            .student-info {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                gap: 1rem;
                margin-top: 1rem;
            }

            .info-item {
                display: flex;
                flex-direction: column;
            }

            .info-label {
                font-size: 0.875rem;
                color: #666;
                margin-bottom: 0.25rem;
            }

            .info-value {
                font-weight: 600;
                color: #333;
            }

            .section {
                background: white;
                padding: 2rem;
                border-radius: 12px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
                margin-bottom: 2rem;
            }

            .section__title {
                font-size: 1.5rem;
                margin-bottom: 1.5rem;
                color: #333;
            }

            .alert {
                padding: 1rem;
                border-radius: 8px;
                margin-bottom: 1.5rem;
                border-left: 4px solid;
            }

            .alert--info {
                background: #e0f2fe;
                color: #0c4a6e;
                border-color: #0369a1;
            }

            .alert--warning {
                background: #fef3c7;
                color: #92400e;
                border-color: #f59e0b;
            }

            .alert--success {
                background: #d1fae5;
                color: #065f46;
                border-color: #10b981;
            }

            .alert--danger {
                background: #fee2e2;
                color: #991b1b;
                border-color: #ef4444;
            }

            .courses-grid {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 1.5rem;
            }

            .course-card {
                background: white;
                border: 2px solid #e1e5f2;
                border-radius: 12px;
                padding: 1.5rem;
                transition: all 0.3s;
            }

            .course-card:hover {
                border-color: #667eea;
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            }

            .course-card__header {
                margin-bottom: 1rem;
            }

            .course-card__code {
                font-size: 0.875rem;
                color: #667eea;
                font-weight: 600;
            }

            .course-card__name {
                font-size: 1.125rem;
                font-weight: bold;
                margin: 0.5rem 0;
            }

            .course-card__body {
                margin-bottom: 1rem;
            }

            .course-detail {
                display: flex;
                justify-content: space-between;
                margin-bottom: 0.5rem;
                font-size: 0.875rem;
            }

            .course-detail__label {
                color: #666;
            }

            .course-detail__value {
                font-weight: 600;
            }

            .badge {
                display: inline-block;
                padding: 0.25rem 0.75rem;
                border-radius: 12px;
                font-size: 0.75rem;
                font-weight: 600;
                margin-right: 0.5rem;
            }

            .badge--remedial {
                background: #fed7d7;
                color: #c53030;
            }

            .badge--official {
                background: #bee3f8;
                color: #2c5282;
            }

            .badge--full {
                background: #fed7d7;
                color: #c53030;
            }

            .badge--available {
                background: #c6f6d5;
                color: #22543d;
            }

            .badge--enrolled {
                background: #e9d8fd;
                color: #553c9a;
            }

            .btn {
                padding: 0.75rem 1.5rem;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 600;
                transition: all 0.3s;
                width: 100%;
            }

            .btn--primary {
                background: #667eea;
                color: white;
            }

            .btn--primary:hover:not(:disabled) {
                background: #5568d3;
            }

            .btn--success {
                background: #48bb78;
                color: white;
            }

            .btn:disabled {
                background: #cbd5e0;
                cursor: not-allowed;
                opacity: 0.6;
            }

            .table {
                width: 100%;
                border-collapse: collapse;
                overflow: hidden;
                border-radius: 8px;
            }

            .table__head {
                background: #667eea;
                color: white;
            }

            .table th,
            .table td {
                padding: 1rem;
                text-align: left;
                border-bottom: 1px solid #f1f3f4;
            }

            .table tbody tr:hover {
                background: #f8f9ff;
            }

            @media (max-width: 768px) {
                .header__content {
                    flex-direction: column;
                    gap: 1rem;
                }

                .courses-grid {
                    grid-template-columns: 1fr;
                }

                .section {
                    padding: 1rem;
                }
            }
        </style>
    </head>
    <body>
        <header class="header">
            <div class="header__content">
                <div class="header__logo">üéì ƒêƒÉng K√Ω L·ªõp Ti·∫øng Anh</div>
                <div class="header__user">
                    <div>
                        <div class="user__name" id="userName">ƒêang t·∫£i...</div>
                        <div class="user__role">Sinh vi√™n</div>
                    </div>
                    <button class="btn-logout" onclick="logout()">
                        ƒêƒÉng xu·∫•t
                    </button>
                </div>
            </div>
        </header>

        <div class="container">
            <!-- Welcome Section -->
            <div class="welcome-section">
                <h2>Xin ch√†o, <span id="studentName"></span>!</h2>
                <div class="student-info" id="studentInfo"></div>
            </div>

            <!-- Eligibility Alert -->
            <div id="eligibilityAlert"></div>

            <!-- Available Courses -->
            <div class="section">
                <h2 class="section__title">L·ªõp h·ªçc c√≥ s·∫µn</h2>
                <div class="courses-grid" id="availableCoursesGrid"></div>
            </div>

            <!-- My Enrollments -->
            <div class="section">
                <h2 class="section__title">L·ªõp h·ªçc ƒë√£ ƒëƒÉng k√Ω</h2>
                <table class="table">
                    <thead class="table__head">
                        <tr>
                            <th>M√£ l·ªõp</th>
                            <th>T√™n l·ªõp</th>
                            <th>Lo·∫°i</th>
                            <th>Gi·∫£ng vi√™n</th>
                            <th>Ng√†y ƒëƒÉng k√Ω</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody id="myEnrollmentsBody"></tbody>
                </table>
            </div>
        </div>

        <script>
            let appData = {
                currentStudent: null,
                courses: [],
                enrollments: [],
                allStudents: [],
            };

            document.addEventListener("DOMContentLoaded", function () {
                checkAuth();
                loadData();
                displayStudentInfo();
                displayEligibilityAlert();
                renderAvailableCourses();
                renderMyEnrollments();
            });

            function checkAuth() {
                const user = localStorage.getItem("currentUser");
                if (!user) {
                    window.location.href = "register&login.html";
                    return;
                }

                const userData = JSON.parse(user);

                if (userData.role !== "student") {
                    alert("B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y!");
                    window.location.href = "register&login.html";
                    return;
                }

                appData.currentStudent = userData;
            }

            function loadData() {
                // Load courses - ƒë·ªçc t·ª´ localStorage do admin qu·∫£n l√Ω
                const savedCourses = localStorage.getItem("courses");
                if (savedCourses) {
                    appData.courses = JSON.parse(savedCourses);
                } else {
                    appData.courses = [];
                }

                // Load all students
                const savedStudents = localStorage.getItem("students");
                if (savedStudents) {
                    appData.allStudents = JSON.parse(savedStudents);
                }

                // Load enrollments
                const savedEnrollments = localStorage.getItem("enrollments");
                if (savedEnrollments) {
                    appData.enrollments = JSON.parse(savedEnrollments);
                } else {
                    appData.enrollments = [];
                }
            }

            function displayStudentInfo() {
                const student = appData.allStudents.find(
                    (s) =>
                        s.studentId === appData.currentStudent.studentId ||
                        s.studentId === appData.currentStudent.username
                );

                if (student) {
                    document.getElementById("userName").textContent =
                        student.fullName;
                    document.getElementById("studentName").textContent =
                        student.fullName;

                    const infoHTML = `
                        <div class="info-item">
                            <span class="info-label">M√£ sinh vi√™n</span>
                            <span class="info-value">${student.studentId}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Email</span>
                            <span class="info-value">${student.email}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">ƒêi·ªÉm THPT</span>
                            <span class="info-value">${
                                student.highSchoolScore
                            }</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Ng√†nh h·ªçc</span>
                            <span class="info-value">${
                                student.major || "Ch∆∞a c·∫≠p nh·∫≠t"
                            }</span>
                        </div>
                    `;
                    document.getElementById("studentInfo").innerHTML = infoHTML;
                }
            }

            function displayEligibilityAlert() {
                const student = appData.allStudents.find(
                    (s) =>
                        s.studentId === appData.currentStudent.studentId ||
                        s.studentId === appData.currentStudent.username
                );

                if (!student) return;

                const alertDiv = document.getElementById("eligibilityAlert");

                if (student.highSchoolScore < 5.0) {
                    alertDiv.innerHTML = `
                        <div class="alert alert--warning">
                            <strong>‚ö†Ô∏è L∆∞u √Ω:</strong> ƒêi·ªÉm THPT c·ªßa b·∫°n l√† ${student.highSchoolScore}. 
                            B·∫°n c·∫ßn ho√†n th√†nh l·ªõp TƒÉng C∆∞·ªùng tr∆∞·ªõc khi ƒëƒÉng k√Ω l·ªõp Ch√≠nh Th·ª©c.
                        </div>
                    `;
                } else {
                    alertDiv.innerHTML = `
                        <div class="alert alert--success">
                            <strong>‚úì ƒê·ªß ƒëi·ªÅu ki·ªán:</strong> B·∫°n c√≥ th·ªÉ ƒëƒÉng k√Ω t·∫•t c·∫£ c√°c l·ªõp h·ªçc!
                        </div>
                    `;
                }
            }

            function renderAvailableCourses() {
                const grid = document.getElementById("availableCoursesGrid");
                grid.innerHTML = "";

                const student = appData.allStudents.find(
                    (s) =>
                        s.studentId === appData.currentStudent.studentId ||
                        s.studentId === appData.currentStudent.username
                );

                if (!student) {
                    grid.innerHTML =
                        "<p>Kh√¥ng t√¨m th·∫•y th√¥ng tin sinh vi√™n</p>";
                    return;
                }

                if (appData.courses.length === 0) {
                    grid.innerHTML =
                        '<p style="text-align: center; color: #999;">Ch∆∞a c√≥ l·ªõp h·ªçc n√†o. Vui l√≤ng li√™n h·ªá admin.</p>';
                    return;
                }

                const canRegisterOfficial = student.highSchoolScore >= 5.0;
                const myEnrollments = appData.enrollments.filter(
                    (e) => e.studentId === student.studentId
                );

                appData.courses.forEach((course) => {
                    const isEnrolled = myEnrollments.some(
                        (e) => e.courseCode === course.code
                    );

                    // ƒê·∫øm s·ªë sinh vi√™n th·ª±c t·∫ø ƒë√£ ƒëƒÉng k√Ω
                    const currentEnrollments = appData.enrollments.filter(
                        (e) => e.courseCode === course.code
                    ).length;

                    const isFull = currentEnrollments >= course.maxStudents;
                    const canEnroll =
                        course.type === "remedial" || canRegisterOfficial;

                    let buttonHTML = "";
                    let statusBadge = "";

                    if (isEnrolled) {
                        buttonHTML =
                            '<button class="btn btn--success" disabled>ƒê√£ ƒëƒÉng k√Ω</button>';
                        statusBadge =
                            '<span class="badge badge--enrolled">ƒê√£ ƒëƒÉng k√Ω</span>';
                    } else if (isFull) {
                        buttonHTML =
                            '<button class="btn" disabled>ƒê√£ ƒë·∫ßy</button>';
                        statusBadge =
                            '<span class="badge badge--full">ƒê√£ ƒë·∫ßy</span>';
                    } else if (!canEnroll) {
                        buttonHTML =
                            '<button class="btn" disabled>Kh√¥ng ƒë·ªß ƒëi·ªÅu ki·ªán</button>';
                        statusBadge =
                            '<span class="badge badge--full">C·∫ßn l·ªõp TC</span>';
                    } else {
                        buttonHTML = `<button class="btn btn--primary" onclick="enrollCourse('${course.code}')">ƒêƒÉng k√Ω ngay</button>`;
                        statusBadge =
                            '<span class="badge badge--available">C√≤n ch·ªó</span>';
                    }

                    const cardHTML = `
                        <div class="course-card">
                            <div class="course-card__header">
                                <div class="course-card__code">${
                                    course.code
                                }</div>
                                <h3 class="course-card__name">${
                                    course.name
                                }</h3>
                                <span class="badge badge--${course.type}">
                                    ${
                                        course.type === "remedial"
                                            ? "TƒÉng C∆∞·ªùng"
                                            : "Ch√≠nh Th·ª©c"
                                    }
                                </span>
                                ${statusBadge}
                            </div>
                            <div class="course-card__body">
                                <div class="course-detail">
                                    <span class="course-detail__label">Gi·∫£ng vi√™n:</span>
                                    <span class="course-detail__value">${
                                        course.instructor
                                    }</span>
                                </div>
                                <div class="course-detail">
                                    <span class="course-detail__label">Sƒ© s·ªë:</span>
                                    <span class="course-detail__value">${currentEnrollments}/${
                        course.maxStudents
                    }</span>
                                </div>
                            </div>
                            ${buttonHTML}
                        </div>
                    `;

                    grid.innerHTML += cardHTML;
                });
            }

            function renderMyEnrollments() {
                const tbody = document.getElementById("myEnrollmentsBody");
                tbody.innerHTML = "";

                const student = appData.allStudents.find(
                    (s) =>
                        s.studentId === appData.currentStudent.studentId ||
                        s.studentId === appData.currentStudent.username
                );

                if (!student) return;

                const myEnrollments = appData.enrollments.filter(
                    (e) => e.studentId === student.studentId
                );

                if (myEnrollments.length === 0) {
                    tbody.innerHTML =
                        '<tr><td colspan="6" style="text-align: center; color: #999;">B·∫°n ch∆∞a ƒëƒÉng k√Ω l·ªõp n√†o</td></tr>';
                    return;
                }

                myEnrollments.forEach((enrollment) => {
                    const course = appData.courses.find(
                        (c) => c.code === enrollment.courseCode
                    );
                    if (course) {
                        const row = `
                            <tr>
                                <td>${course.code}</td>
                                <td>${course.name}</td>
                                <td><span class="badge badge--${course.type}">
                                    ${
                                        course.type === "remedial"
                                            ? "TƒÉng C∆∞·ªùng"
                                            : "Ch√≠nh Th·ª©c"
                                    }
                                </span></td>
                                <td>${course.instructor}</td>
                                <td>${new Date(
                                    enrollment.enrollDate
                                ).toLocaleDateString("vi-VN")}</td>
                                <td>
                                    <button class="btn btn--primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;" 
                                            onclick="unenrollCourse(${
                                                enrollment.id
                                            }, '${course.code}')">
                                        H·ªßy ƒëƒÉng k√Ω
                                    </button>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    }
                });
            }

            function enrollCourse(courseCode) {
                const student = appData.allStudents.find(
                    (s) =>
                        s.studentId === appData.currentStudent.studentId ||
                        s.studentId === appData.currentStudent.username
                );

                if (!student) {
                    alert("Kh√¥ng t√¨m th·∫•y th√¥ng tin sinh vi√™n!");
                    return;
                }

                const course = appData.courses.find(
                    (c) => c.code === courseCode
                );

                if (!course) {
                    alert("Kh√¥ng t√¨m th·∫•y l·ªõp h·ªçc!");
                    return;
                }

                // ƒê·∫øm s·ªë sinh vi√™n th·ª±c t·∫ø ƒë√£ ƒëƒÉng k√Ω
                const currentEnrollments = appData.enrollments.filter(
                    (e) => e.courseCode === course.code
                ).length;

                if (currentEnrollments >= course.maxStudents) {
                    alert("L·ªõp h·ªçc ƒë√£ ƒë·∫ßy!");
                    return;
                }

                const canRegisterOfficial = student.highSchoolScore >= 5.0;
                if (course.type === "official" && !canRegisterOfficial) {
                    alert("B·∫°n c·∫ßn ho√†n th√†nh l·ªõp TƒÉng C∆∞·ªùng tr∆∞·ªõc!");
                    return;
                }

                // Ki·ªÉm tra ƒë√£ ƒëƒÉng k√Ω ch∆∞a
                const alreadyEnrolled = appData.enrollments.some(
                    (e) =>
                        e.studentId === student.studentId &&
                        e.courseCode === course.code
                );

                if (alreadyEnrolled) {
                    alert("B·∫°n ƒë√£ ƒëƒÉng k√Ω l·ªõp n√†y r·ªìi!");
                    return;
                }

                const newEnrollment = {
                    id: Date.now(),
                    studentId: student.studentId,
                    courseCode: course.code,
                    enrollDate: new Date().toISOString(),
                };

                appData.enrollments.push(newEnrollment);

                localStorage.setItem(
                    "enrollments",
                    JSON.stringify(appData.enrollments)
                );

                alert(`ƒêƒÉng k√Ω l·ªõp "${course.name}" th√†nh c√¥ng!`);
                renderAvailableCourses();
                renderMyEnrollments();
            }

            function unenrollCourse(enrollmentId, courseCode) {
                if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ƒëƒÉng k√Ω l·ªõp n√†y?")) {
                    return;
                }

                appData.enrollments = appData.enrollments.filter(
                    (e) => e.id !== enrollmentId
                );

                localStorage.setItem(
                    "enrollments",
                    JSON.stringify(appData.enrollments)
                );

                alert("ƒê√£ h·ªßy ƒëƒÉng k√Ω th√†nh c√¥ng!");
                renderAvailableCourses();
                renderMyEnrollments();
            }

            function logout() {
                if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?")) {
                    localStorage.removeItem("currentUser");
                    localStorage.removeItem("loginTime");
                    window.location.href = "register&login.html";
                }
            }
        </script>
    </body>
</html>
